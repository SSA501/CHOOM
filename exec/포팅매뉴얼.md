# í¬íŒ… ë§¤ë‰´ì–¼

## ê°œë°œí™˜ê²½

**FrontEnd**

- Node.js: `18.15.0`
- npm: `8.19.3`
- React: `18.2.0`

**DevOps**

- Docker: `23.0.1`
- Jenkins: `2.387.1`
- Nginx: `nginx/1.18.0`

**Server**

- AWS EC2: `ubuntu 20.04`
- IntelliJ: `IDEA 2022.3.1`
- SpringBoot: `2.7.9`
- JDK: `OpenJDK 11.0.17`

**Database**

- MySQL: `8.0.32`
- Redis: `7.0.10`

**ê´€ë¦¬**

- GitLab
- Jira
- Notion
- Slack

## í”„ë¡œì íŠ¸ ë¹Œë“œ ë° ë°°í¬

### AWS EC2 ë‚´ Docker ì„¤ì¹˜

1. íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ì§„í–‰
    
    ```bash
    sudo apt-get update
    ```
    
2. í•„ìš” íŒ¨í‚¤ì§€ ì„¤ì¹˜
    
    ```bash
    sudo apt-get install \
    		ca-certificates \
    		curl \
    		gnupg \
    		lsb-release
    ```
    
3. ë„ì»¤ì˜ Official GPG Keyë¥¼ ë“±ë¡
    
    ```bash
    sudo mkdir -p /etc/apt/keyrings
    
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    ```
    
4. stable repository ë“±ë¡
    
    ```bash
    echo \
    		"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    ```
    
5. ë„ì»¤ì™€ ë„ì»¤ ì»´í¬ì¦ˆ ì„¤ì¹˜
    
    ```bash
    # ë„ì»¤ ì„¤ì¹˜
    sudo apt-get update
    sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
    
    # ë„ì»¤ ì»´í¬ì¦ˆ ì„¤ì¹˜
    sudo apt install docker-compose
    ```
    
6. ë„ì»¤ì™€ ë„ì»¤ ì»´í¬ì¦ˆ í™•ì¸
    
    ```bash
    # ë„ì»¤ ì„¤ì¹˜ í™•ì¸
    sudo docker -v
    
    # ë„ì»¤ ì»´í¬ì¦ˆ ì„¤ì¹˜ í™•ì¸
    sudo docker-compose -v  
    ```
    

### AWS EC2 ë‚´ Jenkins ì„¤ì¹˜

1. docker-compose.yml ì‘ì„±
    
    ```yaml
    # docker-compose.yml
    version: '3.4'
    
    services:
    	jenkins:
    		image: jenkins/jenkins:lts
    		user: root
    		restart: always
    		container_name: jenkins
    		volumes:
    			- ./jenkins:/var/jenkins_home
    			- /var/run/docker.sock:/var/run/docker.sock
    		ports:
    			- 8080:8080
    ```
    
2. ë„ì»¤ ì»´í¬ì¦ˆ íŒŒì¼ë¡œ ì»¨í…Œì´ë„ˆ ë„ìš°ê¸°
    
    ```bash
    sudo docker-compose up -d
    ```
    
3. ì  í‚¨ìŠ¤ ë‚´ì—ì„œ docker commandë¥¼ ì‹¤í–‰ì‹œì¼œì•¼ í•˜ê¸° ë•Œë¬¸ì— ë„ì»¤ ì„¤ì¹˜
    
    ```bash
    # ì  í‚¨ìŠ¤ ì ‘ì†
    sudo docker exec -it jenkins bash
    
    # ì  í‚¨ìŠ¤ ì•ˆì— ë„ì»¤ ì„¤ì¹˜
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    ```
    

### Jenkins ì„¤ì • ë° í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜

1. ì  í‚¨ìŠ¤ admin ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    
    ```bash
    sudo docker logs jenkins
    ```
    

1. ì  í‚¨ìŠ¤ì— ì ‘ì†í•´ì„œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ê¸°ë³¸ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
    
    ```
    http://j8a501.p.ssafy.io:8080/
    ```
    
2. ì  í‚¨ìŠ¤ì— ì ‘ì†í•  Admin ê³„ì • ìƒì„± (Create First Admin User)
    - ê³„ì •ëª… : choom
    - ë¹„ë°€ë²ˆí˜¸ : choom123!
    
3. ì¶”ê°€ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
    - GitLab `1.7.9`
    - NodeJS `1.6.0`
    - Generic Webhook Trigger Plugin `1.86.2`

### Jenkins ì•„ì´í…œ ìƒì„±ê³¼ WebHook ì„¤ì •

```
ğŸ’¡ Frontend, Backendë¥¼ ê°ê° ë”°ë¡œ ê´€ë¦¬í•œë‹¤
```

1. Credential ìƒì„±
    - Username : gitlabì˜ ì‚¬ìš©ì id
    - Password : gitlabì˜ ì‚¬ìš©ì password
    - ID : Credentialsë¥¼ êµ¬ë¶„í•˜ëŠ” ID
    
2. ì•„ì´í…œ ìƒì„±
    - FE (Freestyle project)
    - BE (Freestyle project)
    
3. ì†ŒìŠ¤ ì½”ë“œ ê´€ë¦¬
    - Repositories
        - Repository URL : [https://lab.ssafy.com/s08-ai-image-sub2/S08P22A501.git](https://lab.ssafy.com/s08-ai-image-sub2/S08P22A501.git)
        - Credentials : ìœ„ì—ì„œ ë§Œë“  Credentialë¡œ ì§€ì •
    - Branches to build
        - Branch Specifier
            - FE : */frontend
            - BE : */backend
            
4. ë¹Œë“œ ìœ ë°œ
    - **Build when a change is pushed to GitLab. GitLab webhook URL:**
        - Push Events ì„ íƒ
    - Allowed branches
        - Filter branches by name
            - Include
                - FE : frontend
                - BE : backend
                
5. Gitlabì—ì„œ Webhooks ì„¤ì •
    - Gitlab â†’ Settings â†’ Webhooksë¡œ ì´ë™
    - URL
        - http://j8a501.p.ssafy.io:8080/project/FE
        - http://j8a501.p.ssafy.io:8080/project/BE
    - Secret token : ì  í‚¨ìŠ¤ì—ì„œ ë§Œë“  Secret token

### Jenkins ë¹Œë“œ ì„¤ì •

> **FE ì„¤ì •**

1. ì  í‚¨ìŠ¤ ì ‘ì† â†’ Jenkins ê´€ë¦¬ â†’ Global Tool Configurationìœ¼ë¡œ ì´ë™
2. NodeJS intallations ì¶”ê°€
3. Version : NodeJS `18.12.1`
4. FE â†’ Configurationìœ¼ë¡œ ì´ë™
5. Build Steps
    - Execute NodeJS script : ë°©ê¸ˆ ìƒì„±í•œ NodeJS Installation ì¶”ê°€
    - Execute shell
        
        ```bash
        cd FE/frontend
        npm install
        CI=false npm run build
        
        docker compose up --build -d
        ```
        

> **BE ì„¤ì •**

1. ì  í‚¨ìŠ¤ ì„œë²„ ì ‘ì†
    
    ```bash
    sudo docker exec -it jenkins bash
    ```
    
2. /var/jenkins_home/env ë””ë ‰í† ë¦¬ì— application.ymlë¥¼ ìƒì„±
    
    ```
    ğŸ’¡ application.ymlë¥¼ gitignoreì— ì¶”ê°€í–ˆê¸° ë•Œë¬¸ì— ë”°ë¡œ ì„œë²„ì— ì €ì¥í•´ì£¼ëŠ” ê³¼ì •ì´ë‹¤
    ```
    
    ```bash
    cd var/jenkins_home/env
    
    vim application.yml
    ```
    
    ```bash
    # application.yml
    
    server:
      port: 8081
      servlet:
        context-path: /api
    
    spring: 
      datasource:
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://db-mysql:3306/choom?serverTimezone=Asia/Seoul&characterEncoding=UTF-8
        username: [username]
        password: [password]
    
      jpa:
        show-sql: true
        hibernate:
          ddl-auto: update
        properties:
          hibernate:
            format_sql: true
    
      mvc:
        pathmatch:
          matching-strategy: ant_path_matcher
    
      logging:
        file:
          name: ./test.log
        level:
          root: debug
          org:
            springframework:
              web: debug
              boot: debug
              security: debug
    
      servlet:
        # multipart
        multipart:
          max-file-size: 20MB
          max-request-size: 20MB
    
      # redis
      redis:
        host: db-redis
        port: 6379
    
    # jwt
    jwt:
      secret: [jwt ì•”í˜¸í™”ì— ì‚¬ìš©í•  ì„ì˜ì˜ ë¬¸ìì—´]
      # unit is ms. 15 * 24 * 60 * 60 * 1000 = 15days
      expiration:
        atk: 3600000
        rtk: 1296000000
    
    # apikey
    apikey:
      youtube: [google-cloud-api-key]
      kakao: [kakao-api-key]
    
    # redirect-uri
    redirect-uri:
      kakao: https://j8a501.p.ssafy.io/login/oauth2/kakao
      google: https://j8a501.p.ssafy.io/login/oauth2/google
      upload: https://j8a501.p.ssafy.io/upload
    
    # google-client
    google:
      client-id: [google-cloud-client-id]
      client-secret: [google-cloud-client-secret]
    ```
    
3. BE â†’ Configurationìœ¼ë¡œ ì´ë™
4. Build Steps
    - Execute shell
        
        ```bash
        cp /var/jenkins_home/env/application.yml ${WORKSPACE}/BE/src/main/resources
        cd BE
        chmod +x gradlew
        ./gradlew --stacktrace clean build -x test
        
        docker compose up --build -d
        ```
        

### Nginx & SSL ì„¤ì •

1. Nginx ì„¤ì •
    
    ```bash
    sudo apt-get install nginx
    ```
    
2. ì„¤ì¹˜ í™•ì¸
    
    ```bash
    sudo nginx -v
    ```
    
3. Nginx ì¤‘ì§€
    
    ```bash
    sudo systemctl stop nginx
    ```
    
4. Letâ€™s Encrypt ì„¤ì¹˜
    
    ```bash
    sudo apt-get install letsencrypt
    ```
    
5. ì¸ì¦ì„œ ì ìš© ë° .pem í‚¤
    
    ```bash
    sudo letsencrypt certonly --standalone -d [ë„ë©”ì¸]
    ```
    
6. ë°œê¸‰ ê²½ë¡œ í™•ì¸
    
    ```bash
    cd /etc/letsencrypt/live/[ë„ë©”ì¸]
    ```
    
7. ì´ë™ í›„ conf íŒŒì¼ ìƒì„±
    
    ```bash
    cd /etc/nginx/sites-available
    sudo vim choom.conf
    ```
    
    ```bash
    # choom.conf
    server {
            location / {
                    proxy_pass http://localhost:3000;
            }
    
            location /api {
                    proxy_pass http://localhost:8081/api;
            }
    
      listen 443 ssl;
      server_name j8a501.p.ssafy.io;
    
      client_max_body_size 100M;
    
      # ssl ì¸ì¦ì„œ ì ìš©í•˜ê¸°
      ssl_certificate /etc/letsencrypt/live/j8a501.p.ssafy.io/fullchain.pem;
      ssl_certificate_key /etc/letsencrypt/live/j8a501.p.ssafy.io/privkey.pem;
    
    }
    server {
        if ($host = j8a501.p.ssafy.io) {
            return 301 https://$host$request_uri;
        } # managed by Certbot
    
        listen 80;
        server_name j8a501.p.ssafy.io;
          return 404; # managed by Certbot
    }
    ```
    
8. íŒŒì¼ ì—°ë™ ë° í…ŒìŠ¤íŠ¸
    
    ```bash
    sudo ln -s /etc/nginx/sites-available/test.conf /etc/nginx/sites-enabled/choom.conf
    sudo nginx -t
    ```
    
9. Nginx ì¬ì‹œì‘
    
    ```bash
    sudo systemctl restart nginx
    ```
    
10. Nginx ìƒíƒœ í™•ì¸
    
    ```bash
    sudo systemctl status nginx
    ```
